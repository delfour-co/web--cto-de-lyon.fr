<!-- JS Plugins + Main script -->
{{ $scripts := slice }}
{{ $scriptsLazy := slice }}
{{ range site.Params.plugins.js }}
  {{ $plugin := . }}
  {{ if findRE "^http" .link }}
    <script
      src="{{ .link | relURL }}"
      type="application/javascript"
      {{ .attributes | safeHTMLAttr }}></script>
  {{ else }}
    {{ with resources.Get .link }}
      {{ if not $plugin.lazy }}
        {{ $scripts = $scripts | append . }}
      {{ else }}
        {{ $scriptsLazy = $scriptsLazy | append . }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}

<!-- main script -->
{{ $scripts = $scripts | append (resources.Get "js/main.js") }}
{{ $scripts = $scripts | resources.Concat "js/script.js" }}

{{ if hugo.IsProduction }}
  {{ $scripts = $scripts | minify | fingerprint }}
{{ end }}

{{/* scripts */}}
<script
  crossorigin="anonymous"
  integrity="{{ $scripts.Data.Integrity }}"
  src="{{ $scripts.RelPermalink }}"></script>

{{/* scripts lazy — only output if lazy plugins are declared */}}
{{ if $scriptsLazy }}
  {{ $scriptsLazy = $scriptsLazy | resources.Concat "js/script-lazy.js" }}
  {{ if hugo.IsProduction }}
    {{ $scriptsLazy = $scriptsLazy | minify | fingerprint }}
  {{ end }}
  <script
    defer
    async
    crossorigin="anonymous"
    integrity="{{ $scriptsLazy.Data.Integrity }}"
    src="{{ $scriptsLazy.RelPermalink }}"></script>
{{ end }}

{{/* Stubs - modules non utilisés */}}
{{ partialCached "pwa.html" . }}
{{ partialCached "cookie-consent.html" . }}
{{ partialCached "adsense-script.html" . }}
{{ partialCached "announcement-script.html" . }}
