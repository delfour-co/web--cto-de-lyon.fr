---
---

<div id="accessibility-panel" class="fixed bottom-8 left-4 z-40 lg:hidden">
  <!-- Bouton pour ouvrir/fermer le panneau (mobile uniquement) -->
  <button
    id="accessibility-toggle"
    class="bg-primary-600 hover:bg-primary-700 text-white rounded-full p-4 shadow-lg transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-primary-400 focus:ring-offset-2 focus:ring-offset-gray-900"
    aria-label="Ouvrir les paramètres d'accessibilité"
    aria-expanded="false"
    aria-controls="accessibility-overlay"
  >
    <svg
      class="w-6 h-6"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
      xmlns="http://www.w3.org/2000/svg"
      aria-hidden="true"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"
      ></path>
    </svg>
  </button>
</div>

<!-- Overlay pour le menu d'accessibilité (unique pour mobile et desktop) -->
<div
  id="accessibility-overlay"
  class="hidden fixed inset-0 bg-black/50 dark:bg-black/50 bg-black/30 backdrop-blur-sm z-50 flex items-center justify-center p-4"
  role="dialog"
  aria-labelledby="accessibility-title"
  aria-modal="true"
>
  <!-- Panneau d'accessibilité unique (mobile et desktop) -->
  <div
    id="accessibility-menu"
    class="relative w-full max-w-md bg-white dark:bg-gray-800 rounded-lg shadow-2xl border-2 border-gray-300 dark:border-gray-700 p-6 space-y-4 max-h-[90vh] overflow-y-auto"
  >
    <div class="flex justify-between items-center mb-4">
      <h2
        id="accessibility-title"
        class="text-xl font-bold text-white dark:text-white text-gray-900"
      >
        Accessibilité
      </h2>
      <button
        id="accessibility-close"
        class="text-gray-400 dark:text-gray-400 text-gray-600 hover:text-gray-900 dark:hover:text-white transition-colors"
        aria-label="Fermer les paramètres d'accessibilité"
      >
        <svg
          class="w-5 h-5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"
          ></path>
        </svg>
      </button>
    </div>

    <!-- Taille de la police -->
    <div class="space-y-2">
      <label
        for="font-size"
        class="block text-sm font-medium text-gray-300 dark:text-gray-300 text-gray-800"
      >
        Taille de la police
      </label>
      <div class="flex gap-2">
        <button
          data-font-size="small"
          class="font-size-btn flex-1 px-3 py-2 text-sm bg-gray-200 dark:bg-gray-700 hover:bg-primary-500 dark:hover:bg-primary-600 hover:bg-primary-600 text-gray-900 dark:text-white rounded transition-colors border border-gray-300 dark:border-gray-600"
          aria-label="Petite taille de police"
        >
          A-
        </button>
        <button
          data-font-size="normal"
          class="font-size-btn flex-1 px-3 py-2 text-sm bg-primary-600 dark:bg-primary-600 text-white dark:text-white rounded transition-colors border border-primary-700 dark:border-primary-500"
          aria-label="Taille de police normale"
        >
          A
        </button>
        <button
          data-font-size="large"
          class="font-size-btn flex-1 px-3 py-2 text-sm bg-gray-200 dark:bg-gray-700 hover:bg-primary-500 dark:hover:bg-primary-600 hover:bg-primary-600 text-gray-900 dark:text-white rounded transition-colors border border-gray-300 dark:border-gray-600"
          aria-label="Grande taille de police"
        >
          A+
        </button>
        <button
          data-font-size="xlarge"
          class="font-size-btn flex-1 px-3 py-2 text-sm bg-gray-200 dark:bg-gray-700 hover:bg-primary-500 dark:hover:bg-primary-600 hover:bg-primary-600 text-gray-900 dark:text-white rounded transition-colors border border-gray-300 dark:border-gray-600"
          aria-label="Très grande taille de police"
        >
          A++
        </button>
      </div>
    </div>

    <!-- Police pour dyslexiques -->
    <div class="space-y-2">
      <label
        for="dyslexic-font"
        class="block text-sm font-medium text-gray-300 dark:text-gray-300 text-gray-800"
      >
        Police adaptée aux dyslexiques
      </label>
      <div class="flex gap-2">
        <button
          data-font-type="normal"
          class="font-type-btn flex-1 px-3 py-2 text-sm bg-primary-600 dark:bg-primary-600 text-white dark:text-white rounded transition-colors border border-primary-700 dark:border-primary-500"
          aria-label="Police normale"
        >
          Standard
        </button>
        <button
          data-font-type="dyslexic"
          class="font-type-btn flex-1 px-3 py-2 text-sm bg-gray-200 dark:bg-gray-700 hover:bg-primary-500 dark:hover:bg-primary-600 hover:bg-primary-600 text-gray-900 dark:text-white rounded transition-colors border border-gray-300 dark:border-gray-600"
          aria-label="Police adaptée aux dyslexiques"
        >
          Dyslexique
        </button>
      </div>
    </div>

    <!-- Contraste élevé -->
    <div class="flex items-center justify-between">
      <label
        for="high-contrast"
        class="text-sm font-medium text-gray-300 dark:text-gray-300 text-gray-800"
      >
        Contraste élevé
      </label>
      <button
        id="high-contrast-toggle"
        class="relative inline-flex h-6 w-11 items-center rounded-full bg-gray-600 dark:bg-gray-600 transition-colors focus:outline-none focus:ring-2 focus:ring-primary-400 focus:ring-offset-2 focus:ring-offset-white dark:focus:ring-offset-gray-800 border-2 border-gray-700 dark:border-gray-500"
        role="switch"
        aria-checked="false"
        aria-label="Activer le contraste élevé"
      >
        <span
          class="inline-block h-4 w-4 transform rounded-full bg-white dark:bg-gray-200 transition-transform translate-x-1 shadow-lg"
        ></span>
      </button>
    </div>

    <!-- Espacement des lignes -->
    <div class="space-y-2">
      <label
        for="line-height"
        class="block text-sm font-medium text-gray-300 dark:text-gray-300 text-gray-800"
      >
        Espacement des lignes
      </label>
      <div class="flex gap-2">
        <button
          data-line-height="normal"
          class="line-height-btn flex-1 px-3 py-2 text-sm bg-primary-600 dark:bg-primary-600 text-white dark:text-white rounded transition-colors border border-primary-700 dark:border-primary-500"
          aria-label="Espacement normal"
        >
          Normal
        </button>
        <button
          data-line-height="large"
          class="line-height-btn flex-1 px-3 py-2 text-sm bg-gray-200 dark:bg-gray-700 hover:bg-primary-500 dark:hover:bg-primary-600 hover:bg-primary-600 text-gray-900 dark:text-white rounded transition-colors border border-gray-300 dark:border-gray-600"
          aria-label="Grand espacement"
        >
          Large
        </button>
      </div>
    </div>

    <!-- Espacement des lettres -->
    <div class="space-y-2">
      <label
        for="letter-spacing"
        class="block text-sm font-medium text-gray-300 dark:text-gray-300 text-gray-800"
      >
        Espacement des lettres
      </label>
      <div class="flex gap-2">
        <button
          data-letter-spacing="normal"
          class="letter-spacing-btn flex-1 px-3 py-2 text-sm bg-primary-600 dark:bg-primary-600 text-white dark:text-white rounded transition-colors border border-primary-700 dark:border-primary-500"
          aria-label="Espacement normal"
        >
          Normal
        </button>
        <button
          data-letter-spacing="large"
          class="letter-spacing-btn flex-1 px-3 py-2 text-sm bg-gray-200 dark:bg-gray-700 hover:bg-primary-500 dark:hover:bg-primary-600 hover:bg-primary-600 text-gray-900 dark:text-white rounded transition-colors border border-gray-300 dark:border-gray-600"
          aria-label="Grand espacement"
        >
          Large
        </button>
      </div>
    </div>

    <!-- Réinitialiser -->
    <button
      id="reset-accessibility"
      class="w-full px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-900 dark:text-white rounded transition-colors text-sm font-medium border border-gray-300 dark:border-gray-600"
      aria-label="Réinitialiser tous les paramètres d'accessibilité"
    >
      Réinitialiser
    </button>
  </div>
</div>

<script is:inline>
  (function() {
    // Clés pour le localStorage
    const STORAGE_KEYS = {
      FONT_SIZE: 'accessibility_font_size',
      FONT_TYPE: 'accessibility_font_type',
      HIGH_CONTRAST: 'accessibility_high_contrast',
      LINE_HEIGHT: 'accessibility_line_height',
      LETTER_SPACING: 'accessibility_letter_spacing',
    };

    // Valeurs par défaut
    const DEFAULT_VALUES = {
      FONT_SIZE: 'normal',
      FONT_TYPE: 'normal',
      HIGH_CONTRAST: false,
      LINE_HEIGHT: 'normal',
      LETTER_SPACING: 'normal',
    };

    /**
     * Charge les préférences depuis le localStorage
     */
    function loadPreferences() {
      return {
        fontSize: localStorage.getItem(STORAGE_KEYS.FONT_SIZE) || DEFAULT_VALUES.FONT_SIZE,
        fontType: localStorage.getItem(STORAGE_KEYS.FONT_TYPE) || DEFAULT_VALUES.FONT_TYPE,
        highContrast: localStorage.getItem(STORAGE_KEYS.HIGH_CONTRAST) === 'true',
        lineHeight: localStorage.getItem(STORAGE_KEYS.LINE_HEIGHT) || DEFAULT_VALUES.LINE_HEIGHT,
        letterSpacing: localStorage.getItem(STORAGE_KEYS.LETTER_SPACING) || DEFAULT_VALUES.LETTER_SPACING,
      };
    }

    /**
     * Sauvegarde les préférences dans le localStorage
     */
    function savePreferences(prefs) {
      localStorage.setItem(STORAGE_KEYS.FONT_SIZE, prefs.fontSize);
      localStorage.setItem(STORAGE_KEYS.FONT_TYPE, prefs.fontType);
      localStorage.setItem(STORAGE_KEYS.HIGH_CONTRAST, prefs.highContrast.toString());
      localStorage.setItem(STORAGE_KEYS.LINE_HEIGHT, prefs.lineHeight);
      localStorage.setItem(STORAGE_KEYS.LETTER_SPACING, prefs.letterSpacing);
    }

    /**
     * Applique les styles d'accessibilité au document
     */
    function applyAccessibilityStyles(prefs) {
      const root = document.documentElement;
      
      // Taille de la police
      const fontSizeMap = {
        small: '0.875rem',
        normal: '1rem',
        large: '1.125rem',
        xlarge: '1.25rem',
      };
      root.style.setProperty('--accessibility-font-size', fontSizeMap[prefs.fontSize] || fontSizeMap.normal);
      
      // Type de police
      if (prefs.fontType === 'dyslexic') {
        root.classList.add('dyslexic-font');
      } else {
        root.classList.remove('dyslexic-font');
      }
      
      // Contraste élevé
      if (prefs.highContrast) {
        root.classList.add('high-contrast');
      } else {
        root.classList.remove('high-contrast');
      }
      
      // Espacement des lignes
      const lineHeightMap = {
        normal: '1.5',
        large: '2',
      };
      root.style.setProperty('--accessibility-line-height', lineHeightMap[prefs.lineHeight] || lineHeightMap.normal);
      
      // Espacement des lettres
      const letterSpacingMap = {
        normal: '0',
        large: '0.1em',
      };
      root.style.setProperty('--accessibility-letter-spacing', letterSpacingMap[prefs.letterSpacing] || letterSpacingMap.normal);
    }

    /**
     * Met à jour l'interface du panneau selon les préférences
     */
    function updateUI(prefs) {
      // Boutons de taille de police
      document.querySelectorAll('.font-size-btn').forEach(btn => {
        if (btn.dataset.fontSize === prefs.fontSize) {
          btn.classList.add('bg-primary-600', 'dark:bg-primary-600', 'text-white', 'dark:text-white', 'border', 'border-primary-700', 'dark:border-primary-500');
          btn.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-900', 'border-gray-300', 'dark:border-gray-600');
        } else {
          btn.classList.remove('bg-primary-600', 'dark:bg-primary-600', 'text-white', 'dark:text-white');
          btn.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-900', 'border', 'border-gray-300', 'dark:border-gray-600');
        }
      });
      
      // Boutons de type de police
      document.querySelectorAll('.font-type-btn').forEach(btn => {
        if (btn.dataset.fontType === prefs.fontType) {
          btn.classList.add('bg-primary-600', 'dark:bg-primary-600', 'text-white', 'dark:text-white', 'border', 'border-primary-700', 'dark:border-primary-500');
          btn.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-900', 'border-gray-300', 'dark:border-gray-600');
        } else {
          btn.classList.remove('bg-primary-600', 'dark:bg-primary-600', 'text-white', 'dark:text-white');
          btn.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-900', 'border', 'border-gray-300', 'dark:border-gray-600');
        }
      });
      
      // Toggle contraste élevé
      const contrastToggle = document.getElementById('high-contrast-toggle');
      if (contrastToggle) {
        contrastToggle.setAttribute('aria-checked', prefs.highContrast.toString());
        const span = contrastToggle.querySelector('span');
        if (span) {
          if (prefs.highContrast) {
            contrastToggle.classList.add('bg-primary-600', 'dark:bg-primary-600');
            contrastToggle.classList.remove('bg-gray-600', 'dark:bg-gray-600', 'border-gray-700', 'dark:border-gray-500');
            contrastToggle.classList.add('border-primary-700', 'dark:border-primary-500');
            span.classList.remove('translate-x-1');
            span.classList.add('translate-x-6');
          } else {
            contrastToggle.classList.remove('bg-primary-600', 'dark:bg-primary-600', 'border-primary-700', 'dark:border-primary-500');
            contrastToggle.classList.add('bg-gray-600', 'dark:bg-gray-600', 'border-gray-700', 'dark:border-gray-500');
            span.classList.add('translate-x-1');
            span.classList.remove('translate-x-6');
          }
        }
      }
      
      // Boutons d'espacement des lignes
      document.querySelectorAll('.line-height-btn').forEach(btn => {
        if (btn.dataset.lineHeight === prefs.lineHeight) {
          btn.classList.add('bg-primary-600', 'dark:bg-primary-600', 'text-white', 'dark:text-white', 'border', 'border-primary-700', 'dark:border-primary-500');
          btn.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-900', 'border-gray-300', 'dark:border-gray-600');
        } else {
          btn.classList.remove('bg-primary-600', 'dark:bg-primary-600', 'text-white', 'dark:text-white');
          btn.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-900', 'border', 'border-gray-300', 'dark:border-gray-600');
        }
      });
      
      // Boutons d'espacement des lettres
      document.querySelectorAll('.letter-spacing-btn').forEach(btn => {
        if (btn.dataset.letterSpacing === prefs.letterSpacing) {
          btn.classList.add('bg-primary-600', 'dark:bg-primary-600', 'text-white', 'dark:text-white', 'border', 'border-primary-700', 'dark:border-primary-500');
          btn.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-900', 'border-gray-300', 'dark:border-gray-600');
        } else {
          btn.classList.remove('bg-primary-600', 'dark:bg-primary-600', 'text-white', 'dark:text-white');
          btn.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-900', 'border', 'border-gray-300', 'dark:border-gray-600');
        }
      });
    }

    /**
     * Ouvre le menu d'accessibilité
     */
    function openMenu() {
      const overlay = document.getElementById('accessibility-overlay');
      if (overlay) {
        overlay.classList.remove('hidden');
        document.body.style.overflow = 'hidden'; // Empêcher le scroll du body
      }
    }

    /**
     * Ferme le menu d'accessibilité
     */
    function closeMenu() {
      const overlay = document.getElementById('accessibility-overlay');
      if (overlay) {
        overlay.classList.add('hidden');
        document.body.style.overflow = ''; // Restaurer le scroll du body
      }
      // Mettre à jour les attributs aria-expanded
      const toggleBtn = document.getElementById('accessibility-toggle');
      const toggleBtnDesktop = document.getElementById('accessibility-toggle-desktop');
      if (toggleBtn) toggleBtn.setAttribute('aria-expanded', 'false');
      if (toggleBtnDesktop) toggleBtnDesktop.setAttribute('aria-expanded', 'false');
    }

    /**
     * Initialise le panneau d'accessibilité
     */
    function initAccessibility() {
      // Charger les préférences
      let prefs = loadPreferences();
      
      // Appliquer les styles au chargement
      applyAccessibilityStyles(prefs);
      updateUI(prefs);
      
      // Éléments du panneau
      const toggleBtn = document.getElementById('accessibility-toggle');
      const toggleBtnDesktop = document.getElementById('accessibility-toggle-desktop');
      const closeBtn = document.getElementById('accessibility-close');
      const overlay = document.getElementById('accessibility-overlay');
      const resetBtn = document.getElementById('reset-accessibility');
      
      // Ouvrir le menu depuis le bouton mobile
      if (toggleBtn) {
        toggleBtn.addEventListener('click', () => {
          openMenu();
          toggleBtn.setAttribute('aria-expanded', 'true');
        });
      }
      
      // Ouvrir le menu depuis le bouton desktop
      if (toggleBtnDesktop) {
        toggleBtnDesktop.addEventListener('click', (e) => {
          e.stopPropagation();
          e.preventDefault();
          openMenu();
          toggleBtnDesktop.setAttribute('aria-expanded', 'true');
        });
      }
      
      // Fermer le menu
      if (closeBtn) {
        closeBtn.addEventListener('click', closeMenu);
      }
      
      // Fermer en cliquant sur l'overlay (mais pas sur le menu lui-même)
      if (overlay) {
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) {
            closeMenu();
          }
        });
      }
      
      // Fermer avec la touche Escape
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && overlay && !overlay.classList.contains('hidden')) {
          closeMenu();
        }
      });
      
      // Gestion des boutons de taille de police
      document.querySelectorAll('.font-size-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          prefs.fontSize = btn.dataset.fontSize;
          savePreferences(prefs);
          applyAccessibilityStyles(prefs);
          updateUI(prefs);
        });
      });
      
      // Gestion des boutons de type de police
      document.querySelectorAll('.font-type-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          prefs.fontType = btn.dataset.fontType;
          savePreferences(prefs);
          applyAccessibilityStyles(prefs);
          updateUI(prefs);
        });
      });
      
      // Gestion du toggle contraste élevé
      const contrastToggle = document.getElementById('high-contrast-toggle');
      if (contrastToggle) {
        contrastToggle.addEventListener('click', () => {
          prefs.highContrast = !prefs.highContrast;
          savePreferences(prefs);
          applyAccessibilityStyles(prefs);
          updateUI(prefs);
        });
      }
      
      // Gestion des boutons d'espacement des lignes
      document.querySelectorAll('.line-height-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          prefs.lineHeight = btn.dataset.lineHeight;
          savePreferences(prefs);
          applyAccessibilityStyles(prefs);
          updateUI(prefs);
        });
      });
      
      // Gestion des boutons d'espacement des lettres
      document.querySelectorAll('.letter-spacing-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          prefs.letterSpacing = btn.dataset.letterSpacing;
          savePreferences(prefs);
          applyAccessibilityStyles(prefs);
          updateUI(prefs);
        });
      });
      
      // Réinitialiser
      if (resetBtn) {
        resetBtn.addEventListener('click', () => {
          prefs = {
            fontSize: DEFAULT_VALUES.FONT_SIZE,
            fontType: DEFAULT_VALUES.FONT_TYPE,
            highContrast: DEFAULT_VALUES.HIGH_CONTRAST,
            lineHeight: DEFAULT_VALUES.LINE_HEIGHT,
            letterSpacing: DEFAULT_VALUES.LETTER_SPACING,
          };
          savePreferences(prefs);
          applyAccessibilityStyles(prefs);
          updateUI(prefs);
        });
      }
    }

    // Initialiser le panneau d'accessibilité après le chargement du DOM
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initAccessibility);
    } else {
      initAccessibility();
    }
  })();
</script>
